<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DopeMAN - Skills Control Center (v2 Refactored)</title>

    <!-- âœ… é‡æ§‹å¾Œçš„æ¨¡çµ„åŒ– CSS -->
    <link rel="stylesheet" href="css/dashboard-variables.css">
    <link rel="stylesheet" href="css/dashboard-layout.css">

    <!-- â³ åŸå§‹æ¨£å¼ï¼ˆé€æ­¥é·ç§»ä¸­ï¼‰ -->
    <link rel="stylesheet" href="css/dashboard-legacy.css">
</head>
<body>
<div class="container">
        <div class="header">
            <a href="info-stream.html" class="info-stream-btn">
                <span>ğŸ“Š</span>
                <span>å€‹äººè³‡è¨ŠåŒ¯æµ</span>
            </a>
            <a href="task-monitor.html" class="task-monitor-btn">
                <span>ğŸ›ï¸</span>
                <span>ä»»å‹™ç›£æ§</span>
            </a>
            <h1>ğŸ›ï¸ Skills Control Center</h1>
            <p>çœŸå¯¦è³‡æ–™è¦–è¦ºåŒ– - å®Œæ•´ç’°å¢ƒæƒæçµæœ</p>
            <button id="rescanBtn" class="rescan-btn">
                <span class="rescan-icon">ğŸ”„</span>
                <span class="rescan-text">é‡æ–° Scan</span>
            </button>
        </div>

        <!-- çµ±è¨ˆå„€è¡¨æ¿ -->
        <div class="dashboard" id="dashboard">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <!-- ä¸»é¢æ¿ -->
        <div class="main-panel">
            <div class="panel-title">
                <span>ğŸ“Š è©³ç´°è³‡è¨Š</span>
                <span style="font-size: 0.6em; font-weight: normal; color: #999;">
                    æœ€å¾Œæƒæ: <span id="lastScan"></span>
                </span>
            </div>

            <!-- æœå°‹æ¡† -->
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="æœå°‹ Skills, Agents, Rules, Commands...">
            </div>

            <!-- éæ¿¾æŒ‰éˆ• -->
            <div class="filter-buttons" id="filterButtons">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- æ¨™ç±¤é  -->
            <div class="tab-container">
                <div class="tab active" data-tab="skills">Skills</div>
                <div class="tab" data-tab="agents">Agents</div>
                <div class="tab" data-tab="rules">Rules</div>
                <div class="tab" data-tab="commands">Commands</div>
                <div class="tab" data-tab="dev-projects">Dev Projects</div>
                <div class="tab" data-tab="official-market">ğŸª å®˜æ–¹å¸‚å ´</div>
                <div class="tab" data-tab="layers">åˆ†å±¤è¦–åœ–</div>
                <div class="tab" data-tab="settings">âš™ï¸ è¨­å®š</div>
            </div>

            <!-- æ¨™ç±¤é å…§å®¹ -->
            <div id="skills" class="tab-content active">
                <div class="tree-view" id="skillsTree"></div>
            </div>

            <div id="agents" class="tab-content">
                <div class="tree-view" id="agentsTree"></div>
            </div>

            <div id="rules" class="tab-content">
                <div class="tree-view" id="rulesTree"></div>
            </div>

            <div id="commands" class="tab-content">
                <div class="tree-view" id="commandsTree"></div>
            </div>

            <div id="dev-projects" class="tab-content">
                <div class="tree-view" id="devProjectsTree"></div>
            </div>

            <div id="layers" class="tab-content">
                <div class="tree-view" id="layersTree"></div>
            </div>

            <div id="official-market" class="tab-content">
                <div style="padding: 20px;">
                    <h2 style="margin-top: 0; color: #667eea;">ğŸª å®˜æ–¹ Skills & Teams å¸‚å ´</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        å…± <span id="officialTotalCount">0</span> å€‹å®˜æ–¹é …ç›® |
                        å·²å®‰è£ <span id="officialInstalledCount">0</span> å€‹ |
                        å¯å®‰è£ <span id="officialAvailableCount">0</span> å€‹
                    </p>

                    <!-- åˆ†é¡éæ¿¾æŒ‰éˆ• -->
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;" id="marketCategoryFilters">
                        <button class="market-filter-btn active" data-category="all">å…¨éƒ¨</button>
                        <button class="market-filter-btn" data-category="anthropic">Anthropic å®˜æ–¹ (16)</button>
                        <button class="market-filter-btn" data-category="official">DopeMAN å®˜æ–¹ (3)</button>
                        <button class="market-filter-btn" data-category="professional">å°ˆæ¥­ç´š (5)</button>
                        <button class="market-filter-btn" data-category="tools">å·¥å…·æ€§ (2)</button>
                        <button class="market-filter-btn" data-category="reference-projects">åƒè€ƒå°ˆæ¡ˆ (2)</button>
                    </div>

                    <!-- ç‹€æ…‹éæ¿¾ -->
                    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                        <button class="market-status-btn active" data-status="all">å…¨éƒ¨</button>
                        <button class="market-status-btn" data-status="available">å¯å®‰è£</button>
                        <button class="market-status-btn" data-status="installed">å·²å®‰è£</button>
                    </div>

                    <!-- å®˜æ–¹é …ç›®åˆ—è¡¨ -->
                    <div id="officialMarketList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <div style="padding: 20px; max-width: 800px;">
                    <h2 style="margin-top: 0; color: #667eea;">âš™ï¸ ç”¨æˆ¶è¨­å®š</h2>

                    <div class="settings-section">
                        <h3>é è¨­ç·¨è¼¯å™¨</h3>
                        <p style="color: #666; margin-bottom: 15px;">é¸æ“‡é»æ“Šã€ŒOpenã€æŒ‰éˆ•æ™‚ä½¿ç”¨çš„å·¥å…·</p>

                        <div id="editorToolsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- å‹•æ…‹ç”Ÿæˆç·¨è¼¯å™¨é¸é … -->
                        </div>

                        <button onclick="saveSettings()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ğŸ’¾ å„²å­˜è¨­å®š
                        </button>
                        <span id="saveStatus" style="margin-left: 15px; color: #10b981; display: none;">âœ“ å·²å„²å­˜</span>
                    </div>

                    <div class="settings-section" style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #e0e0e0;">
                        <h3>æ–°å¢è‡ªè¨‚å·¥å…·</h3>
                        <p style="color: #666; margin-bottom: 15px;">æ“´å……å·¥å…·åº«ï¼ŒåŠ å…¥æ‚¨å¸¸ç”¨çš„ç·¨è¼¯å™¨æˆ–é–‹ç™¼å·¥å…·</p>

                        <div style="display: grid; grid-template-columns: 1fr 2fr 2fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="newToolIcon" placeholder="ğŸ¯" maxlength="2" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 20px;">
                            <input type="text" id="newToolName" placeholder="å·¥å…·åç¨±" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" id="newToolProtocol" placeholder="protocol://file" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addCustomTool()" style="padding: 8px 15px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                â• æ–°å¢
                            </button>
                        </div>

                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 13px; color: #666;">
                            <strong>ç¯„ä¾‹ï¼š</strong><br>
                            â€¢ WebStorm: <code>webstorm://open?file=</code><br>
                            â€¢ IntelliJ IDEA: <code>idea://open?file=</code><br>
                            â€¢ Sublime Text: <code>subl://open?file=</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>DopeMAN v1.0.0 | Skills Control Center</p>
            <p style="font-size: 0.9em; margin-top: 8px;">æ™ºèƒ½ç’°å¢ƒç®¡ç†ç§˜æ›¸åœ˜éšŠ</p>
        </div>
    </div>

    <script>
        let data = null;
        let filteredData = null;
        let officialCatalog = null;

        // è¼‰å…¥è³‡æ–™
        async function loadData() {
            try {
                // è¼‰å…¥æƒæè³‡æ–™
                const response = await fetch('./control-center-real-data.json');
                data = await response.json();
                filteredData = data;

                // è¼‰å…¥å®˜æ–¹ç›®éŒ„
                try {
                    const catalogResponse = await fetch('./official-catalog.json');
                    officialCatalog = await catalogResponse.json();
                } catch (err) {
                    console.warn('è¼‰å…¥å®˜æ–¹ç›®éŒ„å¤±æ•—:', err);
                }

                renderAll();
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
            }
        }

        // æ¸²æŸ“æ‰€æœ‰å…§å®¹
        function renderAll() {
            renderDashboard();
            renderSkillsTree();
            renderAgentsTree();
            renderRulesTree();
            renderCommandsTree();
            renderDevProjectsTree();
            renderLayersTree();
            renderOfficialMarket();
            renderSettings();
            renderFilters();

            // æ›´æ–°æœ€å¾Œæƒææ™‚é–“
            const lastScan = new Date(data.last_scan);
            document.getElementById('lastScan').textContent = lastScan.toLocaleString('zh-TW');
        }

        // æ¸²æŸ“å„€è¡¨æ¿
        function renderDashboard() {
            const dashboard = document.getElementById('dashboard');
            const cards = [
                {
                    icon: 'ğŸŒ',
                    title: 'å…¨åŸŸ Skills',
                    count: data.categories.global_skills.count,
                    label: 'å·²å®‰è£çš„å…¨åŸŸæŠ€èƒ½',
                    tab: 'skills'
                },
                {
                    icon: 'ğŸ“',
                    title: 'å°ˆæ¡ˆ Skills',
                    count: data.categories.project_skills.count,
                    label: 'å°ˆæ¡ˆç‰¹å®šæŠ€èƒ½',
                    tab: 'skills'
                },
                {
                    icon: 'ğŸ”¨',
                    title: 'é–‹ç™¼ä¸­ Skills',
                    count: data.categories.dev_skills.count,
                    label: 'æœ‰ Git Repo çš„æŠ€èƒ½',
                    tab: 'skills'
                },
                {
                    icon: 'ğŸ“‹',
                    title: 'å…¨åŸŸ Rules',
                    count: data.categories.global_rules.count,
                    label: 'å…¨åŸŸè¦å‰‡',
                    tab: 'rules'
                },
                {
                    icon: 'ğŸ“‚',
                    title: 'å°ˆæ¡ˆ Rules',
                    count: data.categories.project_rules.count,
                    label: 'å°ˆæ¡ˆè¦å‰‡',
                    tab: 'rules'
                },
                {
                    icon: 'ğŸ¤–',
                    title: 'Agents',
                    count: data.categories.agents.count,
                    label: 'Coordinators & Workers',
                    tab: 'agents'
                },
                {
                    icon: 'âŒ¨ï¸',
                    title: 'Commands',
                    count: data.categories.commands.count,
                    label: 'å¯ç”¨æŒ‡ä»¤',
                    tab: 'commands'
                },
                {
                    icon: 'ğŸ’»',
                    title: 'Dev Projects',
                    count: data.categories.dev_projects.count,
                    label: 'é–‹ç™¼å°ˆæ¡ˆ',
                    tab: 'dev-projects'
                }
            ];

            dashboard.innerHTML = cards.map(card => `
                <div class="card" data-tab="${card.tab}" onclick="switchToTab('${card.tab}')">
                    <div class="card-header">
                        <div class="card-icon">${card.icon}</div>
                        <div class="card-title">${card.title}</div>
                    </div>
                    <div class="card-count">${card.count}</div>
                    <div class="card-label">${card.label}</div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“ Skills æ¨¹ç‹€åœ–
        function renderSkillsTree() {
            const tree = document.getElementById('skillsTree');
            const globalSkills = data.categories.global_skills.items;
            const projectSkills = data.categories.project_skills.items;
            const devSkills = data.categories.dev_skills.items;

            let html = '';

            // å…¨åŸŸ Skills
            html += `
                <div class="tree-item">
                    <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                        <span>ğŸŒ å…¨åŸŸ Skills</span>
                        <span class="badge">${globalSkills.length}</span>
                    </div>
                </div>
                <div class="tree-children">
            `;

            globalSkills.slice(0, 20).forEach(skill => {
                const type = skill.type === 'team' ? 'team' : 'single';
                html += `
                    <div class="tree-item tree-indent">
                        <div class="tree-node">
                            <span class="status-dot status-${type}"></span>
                            <span>${skill.name}</span>
                            <span class="badge ${type}">${skill.type}</span>
                        </div>
                    </div>
                `;
            });

            if (globalSkills.length > 20) {
                html += `
                    <div class="tree-item tree-indent">
                        <div class="tree-node" style="color: #999;">
                            ... é‚„æœ‰ ${globalSkills.length - 20} å€‹
                        </div>
                    </div>
                `;
            }

            html += `</div>`;

            // å°ˆæ¡ˆ Skills
            html += `
                <div class="tree-item" style="margin-top: 20px;">
                    <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                        <span>ğŸ“ å°ˆæ¡ˆ Skills</span>
                        <span class="badge">${projectSkills.length}</span>
                    </div>
                </div>
                <div class="tree-children">
            `;

            const projectGroups = {};
            projectSkills.forEach(skill => {
                if (!projectGroups[skill.project_path]) {
                    projectGroups[skill.project_path] = [];
                }
                projectGroups[skill.project_path].push(skill);
            });

            Object.entries(projectGroups).slice(0, 5).forEach(([project, skills]) => {
                html += `
                    <div class="tree-item tree-indent">
                        <div class="tree-node expandable" onclick="toggleExpand(this)">
                            <span>ğŸ“‚ ${project}</span>
                            <span class="badge">${skills.length}</span>
                        </div>
                    </div>
                    <div class="tree-children" style="display: none;">
                `;

                skills.forEach(skill => {
                    html += `
                        <div class="tree-item" style="margin-left: 48px;">
                            <div class="tree-node">
                                <span class="status-dot status-single"></span>
                                <span>${skill.skill_name}</span>
                                ${skill.is_duplicate ? '<span class="badge" style="background: #ef4444;">é‡è¤‡</span>' : ''}
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            html += `</div>`;

            // é–‹ç™¼ä¸­ Skills
            if (devSkills.length > 0) {
                html += `
                    <div class="tree-item" style="margin-top: 20px;">
                        <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                            <span>ğŸ”¨ é–‹ç™¼ä¸­ Skills</span>
                            <span class="badge">${devSkills.length}</span>
                        </div>
                    </div>
                    <div class="tree-children">
                `;

                devSkills.forEach(skill => {
                    html += `
                        <div class="tree-item tree-indent">
                            <div class="tree-node">
                                <span class="status-dot status-team"></span>
                                <span>${skill.name}</span>
                                ${skill.dirty ? '<span class="badge" style="background: #f59e0b;">æœªæäº¤</span>' : ''}
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            tree.innerHTML = html;
        }

        // æ¸²æŸ“ Agents æ¨¹ç‹€åœ–
        function renderAgentsTree() {
            const tree = document.getElementById('agentsTree');
            const agents = data.categories.agents.items;

            const coordinators = agents.filter(a => a.type === 'coordinator');
            const workers = agents.filter(a => a.type === 'worker');

            let html = '';

            // Coordinators
            html += `
                <div class="tree-item">
                    <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                        <span>ğŸ¯ Coordinators</span>
                        <span class="badge coordinator">${coordinators.length}</span>
                    </div>
                </div>
                <div class="tree-children">
            `;

            coordinators.forEach(coord => {
                html += `
                    <div class="tree-item tree-indent">
                        <div class="tree-node">
                            <span class="status-dot status-coordinator"></span>
                            <span>${coord.name}</span>
                            <span style="color: #999; font-size: 0.85em; margin-left: 8px;">
                                â†’ ${coord.belongs_to_project}
                            </span>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;

            // Workers
            html += `
                <div class="tree-item" style="margin-top: 20px;">
                    <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                        <span>ğŸ‘· Workers</span>
                        <span class="badge worker">${workers.length}</span>
                    </div>
                </div>
                <div class="tree-children">
            `;

            const workerGroups = {};
            workers.forEach(worker => {
                if (!workerGroups[worker.group]) {
                    workerGroups[worker.group] = [];
                }
                workerGroups[worker.group].push(worker);
            });

            Object.entries(workerGroups).forEach(([group, groupWorkers]) => {
                html += `
                    <div class="tree-item tree-indent">
                        <div class="tree-node expandable" onclick="toggleExpand(this)">
                            <span>ğŸ“ ${group}</span>
                            <span class="badge">${groupWorkers.length}</span>
                        </div>
                    </div>
                    <div class="tree-children" style="display: none;">
                `;

                groupWorkers.forEach(worker => {
                    html += `
                        <div class="tree-item" style="margin-left: 48px;">
                            <div class="tree-node">
                                <span class="status-dot status-worker"></span>
                                <span>${worker.name}</span>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            html += `</div>`;

            tree.innerHTML = html;
        }

        // æ¸²æŸ“ Rules æ¨¹ç‹€åœ–
        function renderRulesTree() {
            const tree = document.getElementById('rulesTree');
            const globalRules = data.categories.global_rules.items;
            const projectRules = data.categories.project_rules.items;

            let html = '';

            // å…¨åŸŸ Rules
            html += `
                <div class="tree-item">
                    <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                        <span>ğŸŒ å…¨åŸŸ Rules</span>
                        <span class="badge">${globalRules.length}</span>
                    </div>
                </div>
                <div class="tree-children">
            `;

            globalRules.forEach(rule => {
                html += `
                    <div class="tree-item tree-indent">
                        <div class="tree-node">
                            <span>ğŸ“‹ ${rule.name}</span>
                            ${rule.applicability.length > 0 ?
                                `<span style="color: #999; font-size: 0.85em; margin-left: 8px;">
                                    â†’ ${rule.applicability.join(', ')}
                                </span>` : ''}
                        </div>
                    </div>
                `;
            });

            html += `</div>`;

            // å°ˆæ¡ˆ Rules
            html += `
                <div class="tree-item" style="margin-top: 20px;">
                    <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                        <span>ğŸ“ å°ˆæ¡ˆ Rules</span>
                        <span class="badge">${projectRules.length}</span>
                    </div>
                </div>
                <div class="tree-children">
            `;

            const ruleGroups = {};
            projectRules.forEach(rule => {
                if (!ruleGroups[rule.project_path]) {
                    ruleGroups[rule.project_path] = [];
                }
                ruleGroups[rule.project_path].push(rule);
            });

            Object.entries(ruleGroups).forEach(([project, rules]) => {
                html += `
                    <div class="tree-item tree-indent">
                        <div class="tree-node expandable" onclick="toggleExpand(this)">
                            <span>ğŸ“‚ ${project}</span>
                            <span class="badge">${rules.length}</span>
                        </div>
                    </div>
                    <div class="tree-children" style="display: none;">
                `;

                rules.forEach(rule => {
                    html += `
                        <div class="tree-item" style="margin-left: 48px;">
                            <div class="tree-node">
                                <span>ğŸ“‹ ${rule.name}</span>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            html += `</div>`;

            tree.innerHTML = html;
        }

        // æ¸²æŸ“ Commands æ¨¹ç‹€åœ–
        function renderCommandsTree() {
            const tree = document.getElementById('commandsTree');
            const commands = data.categories.commands.items;

            // å–å¾—æ‰€æœ‰å”èª¿è€…å°æ‡‰çš„ skills
            const coordinatorSkills = new Set();
            data.categories.agents.items
                .filter(agent => agent.type === 'coordinator')
                .forEach(agent => {
                    // å¾ agent è·¯å¾‘æå–å°ˆæ¡ˆåç¨±ï¼ˆä¾‹å¦‚å¾ "DEV/.claude/agents/team001-xxx.md" æå– "team001"ï¼‰
                    const pathParts = agent.path.split('/');
                    const fileName = agent.name;

                    // æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰çš„ skillï¼ˆåŒåæˆ–ç›¸åŒå‰ç¶´ï¼‰
                    const matchingSkills = commands.filter(cmd =>
                        cmd.name === fileName ||
                        fileName.startsWith(cmd.name + '-') ||
                        cmd.name.startsWith(fileName.split('-')[0])
                    );
                    matchingSkills.forEach(cmd => coordinatorSkills.add(cmd.name));

                    // é¡å¤–æª¢æŸ¥ï¼šteam001, dopeman, dev-team-* ç­‰åœ˜éšŠå‹ skills
                    if (agent.name.includes('team001')) coordinatorSkills.add('team001');
                    if (agent.name.includes('dopeman')) coordinatorSkills.add('dopeman');
                    if (agent.name.includes('team002')) coordinatorSkills.add('team002');
                });

            // æ’åºï¼šå”èª¿è€…ç›¸é—œçš„ skills å„ªå…ˆ
            const sortedCommands = [...commands].sort((a, b) => {
                const aIsCoordinator = coordinatorSkills.has(a.name) ||
                    a.name.includes('team') ||
                    a.name === 'dopeman';
                const bIsCoordinator = coordinatorSkills.has(b.name) ||
                    b.name.includes('team') ||
                    b.name === 'dopeman';

                if (aIsCoordinator && !bIsCoordinator) return -1;
                if (!aIsCoordinator && bIsCoordinator) return 1;
                return a.name.localeCompare(b.name);
            });

            let html = '';

            sortedCommands.forEach(cmd => {
                const isCoordinator = coordinatorSkills.has(cmd.name) ||
                    cmd.name.includes('team') ||
                    cmd.name === 'dopeman';

                html += `<div class="tree-item">
                    <div class="tree-node">
                        ${isCoordinator ? '<span class="badge coordinator" style="margin-right: 8px;">å”èª¿è€…</span>' : ''}
                        <span style="font-weight: 600; color: #667eea;">${cmd.full_command}</span>
                    </div>
                    <div class="tree-node tree-indent" style="color: #666;">
                        ${cmd.description}
                    </div>
                </div>`;
            });

            tree.innerHTML = html;
        }

        // æ¸²æŸ“ Dev Projects å¡ç‰‡
        function renderDevProjectsTree() {
            const tree = document.getElementById('devProjectsTree');
            const projects = data.categories.dev_projects.items;

            if (projects.length === 0) {
                tree.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">å°šç„¡é–‹ç™¼å°ˆæ¡ˆ</div>';
                return;
            }

            let html = '';

            projects.forEach(project => {
                // å°ˆæ¡ˆé¡å‹æ¨™ç±¤
                const typeClass = `project-type-${project.type}`;
                const typeLabel = {
                    'work': 'å·¥ä½œå°ˆæ¡ˆ',
                    'own-dev': 'å€‹äººé–‹ç™¼',
                    'github-ref': 'GitHub åƒè€ƒ',
                    'other': 'å…¶ä»–'
                }[project.type] || project.type;

                // æŠ€è¡“æ£§æ¨™ç±¤
                const techStackHtml = project.tech_stack.length > 0
                    ? project.tech_stack.map(tech => `<span class="tech-badge">${tech}</span>`).join('')
                    : '<span style="color: #999; font-size: 0.85em;">æœªåµæ¸¬åˆ°æŠ€è¡“æ£§</span>';

                // Git ç‹€æ…‹
                const gitStatus = project.is_dirty
                    ? '<span style="color: #f59e0b;">â— æœªæäº¤</span>'
                    : '<span style="color: #10b981;">âœ“ ä¹¾æ·¨</span>';

                // Claude Team ç‹€æ…‹
                const claudeTeam = project.has_claude_team
                    ? '<span style="color: #667eea;">âœ“ Claude Team</span>'
                    : '<span style="color: #999;">ï¼</span>';

                // æœ€å¾Œ commit è³‡è¨Š
                const lastCommit = project.last_commit_date
                    ? `${new Date(project.last_commit_date).toLocaleDateString('zh-TW')}`
                    : 'ç„¡';

                const commitMsg = project.last_commit_message
                    ? project.last_commit_message.substring(0, 60) + (project.last_commit_message.length > 60 ? '...' : '')
                    : '';

                html += `
                    <div class="project-card">
                        <div class="project-header">
                            <div class="project-name">ğŸ’» ${project.name}</div>
                            <div class="project-type-badge ${typeClass}">${typeLabel}</div>
                        </div>

                        <div class="project-meta">
                            <div class="project-meta-item">
                                <span>ğŸ“</span>
                                <span>${project.path}</span>
                            </div>
                        </div>

                        <div class="tech-stack">
                            <span style="font-weight: 600; color: #666; font-size: 0.85em;">æŠ€è¡“æ£§:</span>
                            ${techStackHtml}
                        </div>

                        <div class="project-meta">
                            <div class="project-meta-item">
                                <span>ğŸ”€ Git:</span>
                                ${gitStatus}
                            </div>
                            <div class="project-meta-item">
                                <span>ğŸ¤–</span>
                                ${claudeTeam}
                            </div>
                            <div class="project-meta-item">
                                <span>ğŸ“… æœ€å¾Œæäº¤:</span>
                                <span>${lastCommit}</span>
                            </div>
                        </div>

                        ${commitMsg ? `
                        <div style="font-size: 0.85em; color: #666; margin-top: 8px; font-style: italic;">
                            "${commitMsg}"
                        </div>
                        ` : ''}

                        <div class="project-actions">
                            <a href="${getEditorUrl(project.path)}" class="action-btn">
                                ${(() => {
                                    const defaultEditor = data.user_preferences?.default_editor || 'vscode';
                                    const tool = data.user_preferences?.editor_tools?.find(t => t.id === defaultEditor);
                                    return tool ? tool.icon : 'ğŸ“‚';
                                })()} Open
                            </a>
                            ${project.remote_url && !project.remote_url.includes('D12CuS8TyU456') ? `
                            <a href="${project.remote_url}" target="_blank" class="action-btn action-btn-secondary">
                                ğŸ”— Git Remote
                            </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            tree.innerHTML = html;
        }

        // æ¸²æŸ“è¨­å®šé é¢
        function renderSettings() {
            if (!data.user_preferences || !data.user_preferences.editor_tools) {
                return;
            }

            const container = document.getElementById('editorToolsContainer');
            const editorTools = data.user_preferences.editor_tools;
            const defaultEditor = data.user_preferences.default_editor || 'vscode';

            let html = '';

            editorTools.forEach(tool => {
                const checked = tool.id === defaultEditor ? 'checked' : '';
                const selected = tool.id === defaultEditor ? 'selected' : '';
                const enabledClass = tool.enabled ? 'enabled' : '';

                html += `
                    <div class="editor-tool-option ${selected}" onclick="selectEditor('${tool.id}')">
                        <input type="radio" name="defaultEditor" value="${tool.id}" ${checked} onclick="event.stopPropagation();">
                        <div class="editor-tool-icon">${tool.icon}</div>
                        <div class="editor-tool-info">
                            <div class="editor-tool-name">${tool.name}</div>
                            <div class="editor-tool-protocol">${tool.protocol}</div>
                        </div>
                        <div class="editor-tool-toggle" onclick="event.stopPropagation(); toggleEditorTool('${tool.id}')">
                            <div class="toggle-switch ${enabledClass}" id="toggle-${tool.id}"></div>
                            <span>${tool.enabled ? 'å•Ÿç”¨' : 'åœç”¨'}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // é¸æ“‡é è¨­ç·¨è¼¯å™¨
        function selectEditor(toolId) {
            // æ›´æ–°è¦–è¦ºç‹€æ…‹
            document.querySelectorAll('.editor-tool-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // æ›´æ–° radio é¸æ“‡
            const radio = event.currentTarget.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;

            // æ›´æ–°è³‡æ–™
            data.user_preferences.default_editor = toolId;
        }

        // åˆ‡æ›å·¥å…·å•Ÿç”¨/åœç”¨
        function toggleEditorTool(toolId) {
            const tool = data.user_preferences.editor_tools.find(t => t.id === toolId);
            if (tool) {
                tool.enabled = !tool.enabled;
                renderSettings();
            }
        }

        // å„²å­˜è¨­å®š
        async function saveSettings() {
            try {
                // é¡¯ç¤ºè¼‰å…¥ä¸­
                const saveBtn = event.target;
                const statusSpan = document.getElementById('saveStatus');
                saveBtn.disabled = true;
                saveBtn.textContent = 'å„²å­˜ä¸­...';

                // æº–å‚™è¦å„²å­˜çš„è³‡æ–™
                const preferencesData = {
                    version: "1.0.0",
                    last_updated: new Date().toISOString(),
                    preferences: data.user_preferences
                };

                // ä½¿ç”¨ Python è…³æœ¬å„²å­˜ï¼ˆå› ç‚ºç€è¦½å™¨ç„¡æ³•ç›´æ¥å¯«æª”æ¡ˆï¼‰
                // å¯¦éš›ä¸Šé€™è£¡éœ€è¦ä¸€å€‹ API endpoint ä¾†è™•ç†å„²å­˜
                // æš«æ™‚åªæ›´æ–°æœ¬åœ°è³‡æ–™å’Œé¡¯ç¤ºæˆåŠŸè¨Šæ¯
                console.log('å„²å­˜è¨­å®š:', preferencesData);

                // TODO: å¯¦ä½œå¯¦éš›çš„å„²å­˜åŠŸèƒ½ï¼ˆéœ€è¦å¾Œç«¯ APIï¼‰
                // å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆï¼š
                // 1. ä½¿ç”¨ Python HTTP server æä¾› POST endpoint
                // 2. ä½¿ç”¨ localStorage æš«å­˜ï¼ˆä½†éœ€è¦é‡æ–°æƒææ™‚å¯«å›æª”æ¡ˆï¼‰

                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                statusSpan.style.display = 'inline';
                saveBtn.textContent = 'ğŸ’¾ å„²å­˜è¨­å®š';
                saveBtn.disabled = false;

                setTimeout(() => {
                    statusSpan.style.display = 'none';
                }, 2000);

                alert('è¨­å®šå·²æ›´æ–°ï¼\\n\\næ³¨æ„ï¼šç›®å‰è¨­å®šåƒ…åœ¨æœ¬æ¬¡ Dashboard æœƒè©±ä¸­ç”Ÿæ•ˆã€‚\\nè‹¥è¦æ°¸ä¹…ä¿å­˜ï¼Œè«‹ä¿®æ”¹ï¼š\\n~/.claude/memory/dopeman/user-preferences.json');
            } catch (error) {
                console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                alert('å„²å­˜è¨­å®šå¤±æ•—ï¼è«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ã€‚');
            }
        }

        // æ–°å¢è‡ªè¨‚å·¥å…·
        function addCustomTool() {
            const iconInput = document.getElementById('newToolIcon');
            const nameInput = document.getElementById('newToolName');
            const protocolInput = document.getElementById('newToolProtocol');

            const icon = iconInput.value.trim() || 'ğŸ”§';
            const name = nameInput.value.trim();
            const protocol = protocolInput.value.trim();

            if (!name || !protocol) {
                alert('è«‹å¡«å¯«å·¥å…·åç¨±å’Œé€šè¨Šå”å®šï¼');
                return;
            }

            // ç”Ÿæˆ ID
            const id = name.toLowerCase().replace(/\s+/g, '-');

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (data.user_preferences.editor_tools.find(t => t.id === id)) {
                alert('æ­¤å·¥å…·å·²å­˜åœ¨ï¼è«‹ä½¿ç”¨ä¸åŒçš„åç¨±ã€‚');
                return;
            }

            // æ–°å¢å·¥å…·
            data.user_preferences.editor_tools.push({
                id: id,
                name: name,
                protocol: protocol,
                enabled: true,
                icon: icon
            });

            // æ¸…ç©ºè¼¸å…¥
            iconInput.value = '';
            nameInput.value = '';
            protocolInput.value = '';

            // é‡æ–°æ¸²æŸ“
            renderSettings();

            alert(`å·¥å…·ã€Œ${name}ã€å·²æ–°å¢ï¼\\nè¨˜å¾—é»æ“Šã€Œå„²å­˜è¨­å®šã€ä¾†ä¿å­˜è®Šæ›´ã€‚`);
        }

        // å–å¾—ç•¶å‰é¸æ“‡çš„ç·¨è¼¯å™¨ URL
        function getEditorUrl(path) {
            if (!data.user_preferences || !data.user_preferences.editor_tools) {
                return `vscode://file${path}`;
            }

            const defaultEditor = data.user_preferences.default_editor || 'vscode';
            const tool = data.user_preferences.editor_tools.find(t => t.id === defaultEditor && t.enabled);

            if (!tool) {
                return `vscode://file${path}`;
            }

            return `${tool.protocol}${path}`;
        }

        // æ¸²æŸ“åˆ†å±¤è¦–åœ–
        function renderLayersTree() {
            const tree = document.getElementById('layersTree');
            const layers = data.layers;

            let html = '';

            // Entry Layer
            html += `
                <div class="tree-item">
                    <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                        <span>ğŸ“ Entry Layer (å…¥å£å±¤)</span>
                    </div>
                </div>
                <div class="tree-children">
                    <div class="tree-item tree-indent">
                        <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                            <span>âŒ¨ï¸ Commands</span>
                            <span class="badge">${layers.entry.commands.length}</span>
                        </div>
                    </div>
                    <div class="tree-children">
            `;

            layers.entry.commands.forEach(cmd => {
                html += `
                    <div class="tree-item" style="margin-left: 48px;">
                        <div class="tree-node">
                            <span>${cmd}</span>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            // Coordination Layer
            html += `
                <div class="tree-item" style="margin-top: 20px;">
                    <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                        <span>ğŸ“ Coordination Layer (å”èª¿å±¤)</span>
                    </div>
                </div>
                <div class="tree-children">
                    <div class="tree-item tree-indent">
                        <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                            <span>ğŸ¯ Coordinators</span>
                            <span class="badge coordinator">${layers.coordination.coordinators.length}</span>
                        </div>
                    </div>
                    <div class="tree-children">
            `;

            layers.coordination.coordinators.forEach(coord => {
                html += `
                    <div class="tree-item" style="margin-left: 48px;">
                        <div class="tree-node">
                            <span class="status-dot status-coordinator"></span>
                            <span>${coord}</span>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            // Execution Layer
            html += `
                <div class="tree-item" style="margin-top: 20px;">
                    <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                        <span>ğŸ“ Execution Layer (åŸ·è¡Œå±¤)</span>
                    </div>
                </div>
                <div class="tree-children">
                    <div class="tree-item tree-indent">
                        <div class="tree-node expandable expanded" onclick="toggleExpand(this)">
                            <span>ğŸ‘· Workers</span>
                            <span class="badge worker">${layers.execution.workers.length}</span>
                        </div>
                    </div>
                    <div class="tree-children">
            `;

            layers.execution.workers.forEach(worker => {
                html += `
                    <div class="tree-item" style="margin-left: 48px;">
                        <div class="tree-node">
                            <span class="status-dot status-worker"></span>
                            <span>${worker}</span>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            tree.innerHTML = html;
        }

        // æ¸²æŸ“éæ¿¾æŒ‰éˆ•
        function renderFilters() {
            const filters = document.getElementById('filterButtons');
            // æš«æ™‚ç•™ç©ºï¼Œä¹‹å¾Œå¯ä»¥åŠ å…¥éæ¿¾åŠŸèƒ½
        }

        // ============ å®˜æ–¹å¸‚å ´ç›¸é—œå‡½æ•¸ ============

        // æ¸²æŸ“å®˜æ–¹å¸‚å ´
        function renderOfficialMarket() {
            if (!officialCatalog) {
                document.getElementById('officialMarketList').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">è¼‰å…¥å®˜æ–¹ç›®éŒ„å¤±æ•—</p>';
                return;
            }

            // æ”¶é›†æ‰€æœ‰å®˜æ–¹é …ç›®
            let allItems = [];
            for (const [categoryKey, category] of Object.entries(officialCatalog.categories)) {
                category.items.forEach(item => {
                    allItems.push({
                        ...item,
                        categoryKey: categoryKey,
                        categoryName: category.name,
                        priority: category.priority || 99
                    });
                });
            }

            // æª¢æŸ¥å“ªäº›å·²å®‰è£
            allItems.forEach(item => {
                item.installed = isInstalled(item);
            });

            // æ›´æ–°çµ±è¨ˆæ•¸å­—
            document.getElementById('officialTotalCount').textContent = allItems.length;
            document.getElementById('officialInstalledCount').textContent = allItems.filter(i => i.installed).length;
            document.getElementById('officialAvailableCount').textContent = allItems.filter(i => !i.installed).length;

            // æ¸²æŸ“åˆ—è¡¨
            renderOfficialList(allItems);

            // ç¶å®šéæ¿¾æŒ‰éˆ•äº‹ä»¶
            setupMarketFilters(allItems);
        }

        // æª¢æŸ¥é …ç›®æ˜¯å¦å·²å®‰è£
        function isInstalled(item) {
            const skillName = item.id;

            // æª¢æŸ¥å…¨åŸŸ Skills
            if (data.categories.global_skills.items.some(s => s.name === skillName)) {
                return true;
            }

            // æª¢æŸ¥å°ˆæ¡ˆ Skills
            if (data.categories.project_skills.items.some(s => s.name === skillName)) {
                return true;
            }

            // æª¢æŸ¥é–‹ç™¼ä¸­ Skills
            if (data.categories.dev_skills.items.some(s => s.name === skillName)) {
                return true;
            }

            // æª¢æŸ¥é–‹ç™¼å°ˆæ¡ˆï¼ˆTeamsï¼‰
            if (data.categories.dev_projects && data.categories.dev_projects.items.some(p => p.name === skillName)) {
                return true;
            }

            return false;
        }

        // æ¸²æŸ“å®˜æ–¹åˆ—è¡¨
        function renderOfficialList(items, filter = { category: 'all', status: 'all' }) {
            const container = document.getElementById('officialMarketList');

            // éæ¿¾é …ç›®
            let filteredItems = items;

            if (filter.category !== 'all') {
                filteredItems = filteredItems.filter(i => i.categoryKey === filter.category);
            }

            if (filter.status !== 'all') {
                if (filter.status === 'installed') {
                    filteredItems = filteredItems.filter(i => i.installed);
                } else if (filter.status === 'available') {
                    filteredItems = filteredItems.filter(i => !i.installed);
                }
            }

            // æ’åºï¼šå„ªå…ˆç´š > å·²å®‰è£ç‹€æ…‹ > åç¨±
            filteredItems.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                if (a.installed !== b.installed) return a.installed ? -1 : 1;
                return a.name.localeCompare(b.name);
            });

            // ç”Ÿæˆ HTML
            if (filteredItems.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®</p>';
                return;
            }

            container.innerHTML = filteredItems.map(item => createOfficialCard(item)).join('');
        }

        // å‰µå»ºå®˜æ–¹å¡ç‰‡
        function createOfficialCard(item) {
            const typeLabel = item.type === 'skill' ? 'Skill' : 'Team';
            const statusLabel = item.installed ? 'å·²å®‰è£' : '';

            // Tags
            const tagsHtml = item.tags ? item.tags.map(tag =>
                `<span class="official-tag">${tag}</span>`
            ).join('') : '';

            // å®‰è£ä½ç½®
            const installPath = item.install_type === 'global_link' ? '~/.claude/skills/' : '~/AgentProjects/';

            // æŒ‰éˆ•
            let actionButtons = '';
            if (item.installed) {
                actionButtons = `
                    <button class="btn-uninstall" onclick="uninstallOfficial('${item.id}', '${item.type}')">
                        ğŸ—‘ï¸ ç§»é™¤
                    </button>
                `;
                if (item.auto_update) {
                    actionButtons += `
                        <button class="btn-update" onclick="updateOfficial('${item.id}')">
                            ğŸ”„ æ›´æ–°
                        </button>
                    `;
                }
            } else {
                actionButtons = `
                    <button class="btn-install" onclick="installOfficial('${item.id}', '${item.type}')">
                        â¬‡ï¸ å®‰è£
                    </button>
                `;
            }

            return `
                <div class="official-card ${item.installed ? 'installed' : ''}">
                    <div class="official-card-header">
                        <div>
                            <div class="official-card-title">${item.name}</div>
                            <div style="display: flex; gap: 6px; margin-top: 6px;">
                                <span class="official-card-badge badge-${item.type}">${typeLabel}</span>
                                ${statusLabel ? `<span class="official-card-badge badge-installed">${statusLabel}</span>` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="official-card-desc">${item.description}</div>

                    ${tagsHtml ? `<div class="official-card-tags">${tagsHtml}</div>` : ''}

                    <div class="official-card-meta">
                        <span>ğŸ“ ${installPath}</span>
                        ${item.auto_update ? '<span>ğŸ”„ è‡ªå‹•æ›´æ–°</span>' : ''}
                        ${item.source ? `<span>ğŸ“¦ ä¾†æº: ${item.source}</span>` : ''}
                    </div>

                    <div class="official-card-actions">
                        ${actionButtons}
                    </div>
                </div>
            `;
        }

        // è¨­å®šå¸‚å ´éæ¿¾å™¨
        function setupMarketFilters(allItems) {
            const categoryButtons = document.querySelectorAll('.market-filter-btn');
            const statusButtons = document.querySelectorAll('.market-status-btn');

            let currentFilter = { category: 'all', status: 'all' };

            categoryButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    categoryButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter.category = btn.getAttribute('data-category');
                    renderOfficialList(allItems, currentFilter);
                });
            });

            statusButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    statusButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter.status = btn.getAttribute('data-status');
                    renderOfficialList(allItems, currentFilter);
                });
            });
        }

        // é‡æ–°æƒæå‡½æ•¸
        function rescan() {
            // å°å‘ä»»å‹™ç›£æ§é é¢åŸ·è¡Œæƒæ
            window.location.href = 'task-monitor.html';
        }

        // å®‰è£å®˜æ–¹ Skill/Team
        async function installOfficial(id, type) {
            const confirmed = confirm(`ç¢ºå®šè¦å®‰è£ ${id} (${type === 'skill' ? 'Skill' : 'Team'}) å—ï¼Ÿ\n\né€™å°‡åŸ·è¡Œå®‰è£è…³æœ¬ä¸¦å¯èƒ½éœ€è¦å¹¾ç§’é˜æ™‚é–“ã€‚`);
            if (!confirmed) return;

            try {
                // å‘¼å«å¾Œç«¯ API æˆ–è…³æœ¬
                const response = await fetch('/api/install-official', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, type })
                });

                if (response.ok) {
                    alert(`âœ… ${id} å®‰è£æˆåŠŸï¼\n\nè«‹é‡æ–° Scan ä»¥æŸ¥çœ‹æœ€æ–°ç‹€æ…‹ã€‚`);
                    // å»ºè­°é‡æ–°æƒæ
                    if (confirm('æ˜¯å¦ç«‹å³é‡æ–°æƒæï¼Ÿ')) {
                        rescan();
                    }
                } else {
                    throw new Error('å®‰è£å¤±æ•—');
                }
            } catch (error) {
                console.error('å®‰è£å¤±æ•—:', error);
                alert(`âŒ å®‰è£å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}\n\nè«‹æ‰‹å‹•åŸ·è¡Œï¼š\ncd ~/AgentProjects/dopeman/dopeman-app/commands\n./install-official.py`);
            }
        }

        // ç§»é™¤å®˜æ–¹ Skill/Team
        async function uninstallOfficial(id, type) {
            const confirmed = confirm(`ç¢ºå®šè¦ç§»é™¤ ${id} (${type === 'skill' ? 'Skill' : 'Team'}) å—ï¼Ÿ\n\né€™å°‡åˆªé™¤å·²å®‰è£çš„æª”æ¡ˆã€‚`);
            if (!confirmed) return;

            try {
                const response = await fetch('/api/uninstall-official', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, type })
                });

                if (response.ok) {
                    alert(`âœ… ${id} å·²ç§»é™¤ï¼\n\nè«‹é‡æ–° Scan ä»¥æŸ¥çœ‹æœ€æ–°ç‹€æ…‹ã€‚`);
                    if (confirm('æ˜¯å¦ç«‹å³é‡æ–°æƒæï¼Ÿ')) {
                        rescan();
                    }
                } else {
                    throw new Error('ç§»é™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('ç§»é™¤å¤±æ•—:', error);
                alert(`âŒ ç§»é™¤å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}\n\nè«‹æ‰‹å‹•åˆªé™¤ï¼š\n~/.claude/skills/${id}\næˆ–\n~/AgentProjects/${id}`);
            }
        }

        // æ›´æ–°å®˜æ–¹ Skill/Team
        async function updateOfficial(id) {
            const confirmed = confirm(`ç¢ºå®šè¦æ›´æ–° ${id} å—ï¼Ÿ\n\né€™å°‡å¾ upstream æ‹‰å–æœ€æ–°ç‰ˆæœ¬ã€‚`);
            if (!confirmed) return;

            try {
                const response = await fetch('/api/update-official', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (response.ok) {
                    alert(`âœ… ${id} æ›´æ–°æˆåŠŸï¼`);
                    if (confirm('æ˜¯å¦ç«‹å³é‡æ–°æƒæï¼Ÿ')) {
                        rescan();
                    }
                } else {
                    throw new Error('æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                console.error('æ›´æ–°å¤±æ•—:', error);
                alert(`âŒ æ›´æ–°å¤±æ•—ï¼\n\néŒ¯èª¤: ${error.message}\n\nè«‹æ‰‹å‹•åŸ·è¡Œï¼š\ncd ~/.claude/skills/${id}\ngit pull`);
            }
        }

        // ============ å®˜æ–¹å¸‚å ´ç›¸é—œå‡½æ•¸çµæŸ ============

        // åˆ‡æ›å±•é–‹/æ‘ºç–Š
        function toggleExpand(element) {
            element.classList.toggle('expanded');

            // æ‰¾åˆ°ä¸‹ä¸€å€‹ tree-children å®¹å™¨
            let sibling = element.parentElement.nextElementSibling;

            // å¦‚æœä¸‹ä¸€å€‹å…ƒç´ æ˜¯ tree-childrenï¼Œåˆ‡æ›å…¶é¡¯ç¤ºç‹€æ…‹
            if (sibling && sibling.classList.contains('tree-children')) {
                if (element.classList.contains('expanded')) {
                    sibling.style.display = 'block';
                } else {
                    sibling.style.display = 'none';
                }
            }
        }

        // åˆ‡æ›åˆ°æŒ‡å®š Tab çš„å‡½æ•¸
        function switchToTab(tabId) {
            // ç§»é™¤æ‰€æœ‰ active
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // å•Ÿç”¨ç›®æ¨™ tab
            const targetTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            const targetContent = document.getElementById(tabId);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }

        // æ¨™ç±¤é åˆ‡æ›
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                switchToTab(tabId);
            });
        });

        // æœå°‹åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            // TODO: å¯¦ä½œæœå°‹éæ¿¾
        });

        // é‡æ–° Scan åŠŸèƒ½
        document.getElementById('rescanBtn').addEventListener('click', async () => {
            // å°å‘ä»»å‹™ç›£æ§é é¢åŸ·è¡Œæƒæ
            if (confirm('é‡æ–°æƒæåŠŸèƒ½å·²ç§»è‡³ã€Œä»»å‹™ç›£æ§ã€é é¢\n\næ˜¯å¦å‰å¾€ä»»å‹™ç›£æ§é é¢åŸ·è¡Œæƒæï¼Ÿ')) {
                window.location.href = 'task-monitor.html';
            }
        });

        // åˆå§‹åŒ–
        loadData();
    </script>

<!-- âœ… é‡æ§‹å¾Œçš„æ¨¡çµ„åŒ– JavaScript -->
<script src="js/dashboard-config.js"></script>
<script src="js/dashboard-state.js"></script>
<script src="js/dashboard-api.js"></script>

<!-- â³ åŸå§‹ç¨‹å¼ç¢¼ï¼ˆé€æ­¥é·ç§»ä¸­ï¼‰ -->
<script src="js/dashboard-legacy.js"></script>

<script>
    /**
     * æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
     * æ•´åˆæ–°èˆŠç³»çµ±
     */
    console.log('âœ… DopeMAN Dashboard v2 (Refactored) loaded');
    console.log('ğŸ“¦ Modules:', {
        Config: typeof DashboardConfig !== 'undefined',
        State: typeof DashboardState !== 'undefined',
        API: typeof DashboardAPI !== 'undefined'
    });
</script>
</body>
</html>
